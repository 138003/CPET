<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPET 專業報告系統 V12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .section-card { @apply p-4 bg-slate-50 rounded-xl border border-slate-200 shadow-sm mb-4; }
        .input-label { @apply text-xs font-bold text-slate-500 uppercase mb-1 block; }
        .form-input { @apply w-full p-2 border rounded text-base focus:ring-2 focus:ring-indigo-500 outline-none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-10 font-sans text-slate-800">
    <div class="max-w-[1500px] mx-auto mt-6 bg-white shadow-2xl rounded-3xl overflow-hidden border border-slate-200">
        <div class="bg-slate-900 p-5 text-white flex justify-between items-center border-b border-indigo-500/30">
            <div>
                <h1 class="text-xl font-black tracking-tighter text-indigo-400">PFT & CPET SYSTEM V12</h1>
                <p class="text-[10px] text-slate-400 font-medium uppercase tracking-widest">Clinical Decision Support Integrated</p>
            </div>
            <div id="drugAlert" class="hidden bg-orange-600 text-white px-4 py-2 rounded-lg text-xs font-bold animate-bounce shadow-lg">
                ⚠️ DRUG MODIFICATION REMINDER: Slope < 34 with HR/BP suppression
            </div>
        </div>

        <div class="p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-5 space-y-4 max-h-[85vh] overflow-y-auto pr-2 custom-scrollbar">
                
                <div class="section-card border-l-8 border-l-blue-500">
                    <h2 class="text-sm font-black text-blue-700 mb-3 border-b pb-1">A: Pulmonary Function Test</h2>
                    <select id="pftStatus" class="form-input text-sm mb-3">
                        <option value="normal results">normal results</option>
                        <option value="at low flow rate (PEF<60%)">at low flow rate (PEF<60%)</option>
                        <option value="mild obstructive impairment(if FEV1/FVC<70%)">mild obstructive impairment(if FEV1/FVC<70%)</option>
                        <option value="mild restrictive impairment(<80% norm)">mild restrictive impairment(<80% norm)</option>
                    </select>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="input-label">FEV1/FVC (%)</label><input id="fevfvc" type="number" step="0.1" class="form-input"></div>
                        <div><label class="input-label">FVC (% pred.)</label><input id="fvc_pred" type="number" step="0.1" class="form-input"></div>
                    </div>
                </div>

                <div class="section-card">
                    <h2 class="text-sm font-black text-slate-700 mb-3 border-b pb-1">B: CPTX - Numerical Data</h2>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div><label class="input-label">Age</label><input id="age" type="number" class="form-input"></div>
                        <div><label class="input-label">Rest HR</label><input id="restHR" type="number" class="form-input"></div>
                        <div><label class="input-label">Peak HR</label><input id="peakHR" type="number" class="form-input"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div><label class="input-label">Peak VO2 (ml/kg)</label><input id="peakVO2_ml" type="number" step="0.1" class="form-input" oninput="checkDrugAlert()"></div>
                        <div><label class="input-label">Peak VO2 (L/min)</label><input id="peakVO2_L" type="number" step="0.1" class="form-input"></div>
                        <div class="col-span-2"><label class="input-label">Pred. VO2 (L/min)</label><input id="predVO2_L" type="number" step="0.1" class="form-input"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="input-label">VE max</label><input id="veMax" type="number" class="form-input"></div>
                        <div><label class="input-label">FEV1 (L)</label><input id="fev1" type="number" step="0.1" class="form-input"></div>
                        <div><label class="input-label">OUES</label><input id="oues" type="number" class="form-input"></div>
                        <div><label class="input-label">VE/VCO2 slope</label><input id="vevco2" type="number" step="0.1" class="form-input" oninput="checkDrugAlert()"></div>
                        <div><label class="input-label">O2 pulse</label><input id="o2p" type="number" step="0.1" class="form-input"></div>
                        <div><label class="input-label">Pred. O2 pulse</label><input id="predO2p" type="number" step="0.1" class="form-input"></div>
                    </div>
                </div>

                <div class="section-card bg-indigo-50 border-indigo-200">
                    <h2 class="text-sm font-black text-indigo-700 mb-3 border-b pb-1">Qualitative Selections</h2>
                    <div class="space-y-3 mb-4">
                        <select id="ekgStatus" class="form-input text-xs" onchange="toggleField('ekgOtherText', this.value==='OTHER')">
                            <option value="no significant arrythmia or ST-T change during examination">EKG: normal/no significant ST change</option>
                            <option value="occasional VPCs and APCs noted during exercise">EKG: occasional VPCs and APCs</option>
                            <option value="OTHER">EKG: OTHER (Manual Input)</option>
                        </select>
                        <input id="ekgOtherText" type="text" placeholder="Specify EKG..." class="hidden form-input text-xs border-orange-300 bg-orange-50">
                        
                        <select id="option6" class="form-input text-xs" onchange="checkDrugAlert()">
                            <option value="chronotropic incompetence was noted">Chronotropic incompetence: YES</option>
                            <option value="Steep HR vs VO2 response was noted">Steep HR vs VO2 response was noted</option>
                        </select>
                    </div>

                    <div class="flex gap-4 text-xs font-bold mb-4">
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="check12"> 12. Delayed HR rec.</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="check13" onchange="checkDrugAlert()"> 13. Inadequate BP</label>
                    </div>
                </div>

                <div class="section-card border-l-8 border-l-emerald-500">
                    <h2 class="text-sm font-black text-emerald-700 mb-3 border-b pb-1">Conclusion & Suggestion</h2>
                    
                    <div class="space-y-3 mb-4">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Conclusions:</p>
                        <label class="flex items-center gap-2 text-xs"><input type="checkbox" id="con1"> 1. Abnormal (FAI Severity)</label>
                        <label class="flex items-center gap-2 text-xs"><input type="checkbox" id="con2"> 2. Essentially normal</label>
                        <label class="flex items-center gap-2 text-xs"><input type="checkbox" id="con3"> 3. Inconclusive</label>
                        <div class="flex items-center gap-2 text-xs">
                            <input type="checkbox" id="con4"> 
                            <select id="con4_state" class="p-1 border rounded bg-white"><option>Improved</option><option>Stationary</option><option>Deteriorated</option></select>
                            <span class="mx-1">since</span>
                            <input id="prevDate" type="date" class="p-1 border rounded">
                        </div>
                    </div>

                    <div class="space-y-3 pt-3 border-t">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Suggestions:</p>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" id="sug1"> 1. Continue Phase II CPT with:</label>
                            <div class="grid grid-cols-2 gap-1 pl-6 text-[10px]">
                                <label><input type="checkbox" class="sug_opt" value="RPE guided intensity"> RPE intensity</label>
                                <label><input type="checkbox" class="sug_opt" value="breathing retraining"> breathing retrain</label>
                                <label><input type="checkbox" class="sug_opt" value="resistance training"> resistance</label>
                                <label><input type="checkbox" class="sug_opt" value="endurance training"> endurance</label>
                            </div>
                        </div>
                        <label class="flex items-center gap-2 text-xs"><input type="checkbox" id="sug2"> 2. Drug modification</label>
                    </div>
                </div>

                <button onclick="generateReport()" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-black transition-all uppercase tracking-widest active:scale-95">
                    Generate Final Report
                </button>
            </div>

            <div class="lg:col-span-7">
                <div class="sticky top-6">
                    <div class="flex justify-between items-center mb-2 px-2">
                        <h2 class="font-bold text-slate-500 text-[10px] tracking-[0.4em] uppercase">Integrated Clinical Report</h2>
                        <button onclick="copyToClipboard()" class="bg-indigo-600 text-white px-10 py-2 rounded-full text-xs font-bold hover:bg-indigo-700 shadow-lg transition-transform hover:scale-105 active:scale-95 uppercase">Copy All</button>
                    </div>
                    <textarea id="reportText" class="w-full h-[880px] p-8 text-[13.5px] font-mono border-2 border-slate-300 rounded-[2.5rem] bg-white leading-relaxed shadow-inner outline-none focus:border-indigo-400" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleField(id, show) { document.getElementById(id).classList.toggle('hidden', !show); }

        function checkDrugAlert() {
            const slope = parseFloat(document.getElementById('vevco2').value) || 0;
            const isCI = document.getElementById('option6').value === 'chronotropic incompetence was noted';
            const isInadequateBP = document.getElementById('check13').checked;
            const alertDiv = document.getElementById('drugAlert');

            if (slope > 0 && slope < 34 && (isCI || isInadequateBP)) {
                alertDiv.classList.remove('hidden');
            } else {
                alertDiv.classList.add('hidden');
            }
        }

        function getFAISeverity(fai) {
            if (fai <= 28) return "no significant";
            if (fai <= 40) return "mild FAI";
            if (fai <= 54) return "moderate FAI";
            if (fai <= 68) return "marked FAI";
            return "extremely FAI";
        }

        function generateReport() {
            // A: PFT
            const pft = `A: pulmonary function test: ${document.getElementById('pftStatus').value}\n1. FEV1/FVC=${document.getElementById('fevfvc').value || "__"}%\n2. FVC:${document.getElementById('fvc_pred').value || "__"}% predicted value\n`;

            // B: CPET Calcs
            const age = parseFloat(document.getElementById('age').value);
            const restHR = parseFloat(document.getElementById('restHR').value) || 0;
            const peakHR = parseFloat(document.getElementById('peakHR').value) || 0;
            const peakVO2_ml = parseFloat(document.getElementById('peakVO2_ml').value) || 0;
            const peakVO2_L = parseFloat(document.getElementById('peakVO2_L').value) || 0;
            const predVO2_L = parseFloat(document.getElementById('predVO2_L').value) || 1;
            const o2p = parseFloat(document.getElementById('o2p').value) || 0;
            const predO2p = parseFloat(document.getElementById('predO2p').value) || 1;

            const ciValue = age ? ((peakHR - restHR) / ((220 - age) - restHR)).toFixed(2) : "____";
            const pPeakHR = age ? (peakHR * 100 / (220 - age)).toFixed(1) : "____";
            const peakMETs = (peakVO2_ml / 3.5).toFixed(1);
            const pPeakVO2 = (peakVO2_L * 100 / predVO2_L).toFixed(1);
            const fai = (100 - (peakVO2_L / predVO2_L * 100)).toFixed(1);
            const di = (parseFloat(document.getElementById('veMax').value) / (40 * parseFloat(document.getElementById('fev1').value) || 1)).toFixed(2);
            const br = (1 - di).toFixed(2);
            const pO2p = (o2p * 100 / predO2p).toFixed(1);

            // B: Qualitative
            const ekgSel = document.getElementById('ekgStatus').value;
            const ekgFinal = ekgSel === 'OTHER' ? document.getElementById('ekgOtherText').value : ekgSel;
            const opt6 = document.getElementById('option6').value;
            const check12 = document.getElementById('check12').checked ? `12. Delayed heart rate recovery was observed\n` : "";
            const check13 = document.getElementById('check13').checked ? `13. Inadequate BP response was noted\n` : "";

            // Conclusion logic
            let conText = "\nConclusion:\n";
            if (document.getElementById('con1').checked) conText += `- Abnormal exercise testing with ${getFAISeverity(fai)} FAI; the cause was due to decreased cardiac and pulmonary capacity;\n`;
            if (document.getElementById('con2').checked) conText += `- Essentially normal exercise testing\n`;
            if (document.getElementById('con3').checked) conText += `- Inconclusive exercise testing\n`;
            if (document.getElementById('con4').checked) {
                const date = document.getElementById('prevDate').value || "____";
                conText += `- ${document.getElementById('con4_state').value} compared to previous exam on ${date}\n`;
            }

            // Suggestion logic
            let sugText = "\nSuggestion:\n";
            if (document.getElementById('sug1').checked) {
                const opts = Array.from(document.querySelectorAll('.sug_opt:checked')).map(c => c.value).join(", ");
                sugText += `1. continue phase II CPT with {${opts || "____"}}\n`;
            }
            if (document.getElementById('sug2').checked) sugText += `2. Drug modification.\n`;

            const fullReport = `${pft}\nB: CPTX result
1. max HR:${peakHR};% predicted peak HR=${pPeakHR}%
2. peak VO2:${peakVO2_ml}ml/kg/min; peak MET:${peakMETs}METs;% predicted peak VO2:${pPeakVO2}%
3. % FAI=${fai}%
4. Dyspnea index=${di};Breathing reserve=${br}
5. EKG: ${ekgFinal || "____"}
6. ${opt6}; CI=${ciValue} (nl<0.8, if on BB<0.6)
7. OUES: ${document.getElementById('oues').value} ml/min
8. VE/VCO2 slope: ${document.getElementById('vevco2').value}
9. O2 pulse: ${o2p} ; ${pO2p}% of predicted
10. Exercise was terminated due to submaximal result
11. AT not reached
${check12}${check13}14. normal SpO2 response during exam
${conText}${sugText}`;

            document.getElementById('reportText').value = fullReport;
        }

        function copyToClipboard() {
            const copyText = document.getElementById("reportText");
            if (!copyText.value) return;
            copyText.select();
            document.execCommand("copy");
            alert("完整報告已複製到剪貼簿。");
        }
    </script>
</body>
</html>
