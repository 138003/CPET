<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFT & CPET Report System V12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type="checkbox"]:checked + span {
            color: #4f46e5;
            font-weight: 700;
        }
        /* 隱藏滾動條但保持功能 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10 font-sans text-slate-800">
    <div class="max-w-[1400px] mx-auto mt-6 bg-white shadow-2xl rounded-2xl overflow-hidden border border-slate-200">
        <div class="bg-slate-900 p-5 text-white flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-indigo-400">PFT & CPET Report System V12</h1>
                <p class="text-xs text-slate-400 font-medium">No numbering / Updated Point 6 / Clean Suggestions</p>
            </div>
        </div>

        <div class="p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-5 space-y-5 h-[880px] overflow-y-auto pr-2 custom-scrollbar">
                
                <section class="p-4 bg-blue-50 rounded-xl border border-blue-100 shadow-sm">
                    <h2 class="text-sm font-bold text-blue-800 mb-3 border-b border-blue-200 pb-1 text-center">A: Pulmonary Function Test</h2>
                    <div class="space-y-3">
                        <label class="text-xs font-bold text-slate-600 block">PFT 結果判定</label>
                        <select id="pftStatus" class="w-full p-2 border rounded text-sm bg-white outline-blue-500">
                            <option value="normal results">normal results</option>
                            <option value="at low flow rate (PEF<60%)">at low flow rate (PEF<60%)</option>
                            <option value="mild obstructive impairment(if FEV1/FVC<70%)">mild obstructive impairment(if FEV1/FVC<70%)</option>
                            <option value="mild restrictive impairment(<80% norm)">mild restrictive impairment(<80% norm)</option>
                        </select>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="text-xs font-bold text-slate-600 uppercase">FEV1/FVC (%)
                                <input id="fevfvc" type="number" step="0.1" class="w-full mt-1 p-2 border rounded text-base">
                            </label>
                            <label class="text-xs font-bold text-slate-600 uppercase">FVC (% pred.)
                                <input id="fvc_pred" type="number" step="0.1" class="w-full mt-1 p-2 border rounded text-base">
                            </label>
                        </div>
                    </div>
                </section>

                <section class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <h2 class="text-sm font-bold text-slate-700 mb-3 border-b pb-1 text-center">B: CPTX - 基礎數據</h2>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <label class="text-xs font-bold text-slate-500">年齡 <input id="age" type="number" class="w-full p-2 border rounded mt-1 text-base"></label>
                        <label class="text-xs font-bold text-slate-500">Rest HR <input id="restHR" type="number" class="w-full p-2 border rounded mt-1 text-base"></label>
                        <label class="text-xs font-bold text-slate-500">Peak HR <input id="peakHR" type="number" class="w-full p-2 border rounded mt-1 text-base"></label>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <label class="text-xs font-bold text-slate-500">Peak VO2 (ml/kg) <input id="peakVO2_ml" type="number" step="0.1" class="w-full p-2 border rounded mt-1 text-base"></label>
                        <label class="text-xs font-bold text-slate-500">Peak VO2 (L/min) <input id="peakVO2_L" type="number" step="0.1" class="w-full p-2 border rounded mt-1 text-base"></label>
                        <label class="text-xs font-bold text-slate-500">Pred. VO2 (L/min) <input id="predVO2_L" type="number" step="0.1" class="w-full p-2 border rounded mt-1 col-span-2 text-base"></label>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <label class="font-bold text-slate-500">VE max <input id="veMax" type="number" class="w-full p-2 border rounded mt-1 text-base"></label>
                        <label class="font-bold text-slate-500">FEV1 (L) <input id="fev1" type="number" step="0.1" class="w-full p-2 border rounded mt-1 text-base"></label>
                        <label class="font-bold text-slate-500">OUES <input id="oues" type="number" class="w-full p-2 border rounded mt-1 text-base"></label>
                        <label class="font-bold text-slate-500">VE/VCO2 slope <input id="vevco2" type="number" step="0.1" class="w-full p-2 border rounded mt-1 text-base"></label>
                        <label class="font-bold text-slate-500">O2 pulse <input id="o2p" type="number" step="0.1" class="w-full p-2 border rounded mt-1 text-base"></label>
                        <label class="font-bold text-slate-500">Pred. O2 pulse <input id="predO2p" type="number" step="0.1" class="w-full p-2 border rounded mt-1 text-base"></label>
                    </div>
                </section>

                <section class="p-4 bg-indigo-50 rounded-xl border border-indigo-100 space-y-4">
                    <h2 class="text-sm font-bold text-indigo-700 border-b pb-1 text-center uppercase tracking-widest">B: CPTX - Qualitative Analysis</h2>
                    
                    <div class="bg-white p-3 rounded-lg border border-indigo-200">
                        <label class="text-xs font-bold text-indigo-800 block mb-2 uppercase">5. EKG 心電圖表現</label>
                        <select id="ekgStatus" class="w-full p-2 border rounded text-xs bg-slate-50 outline-indigo-500 mb-2" onchange="toggleEKGOther()">
                            <option value="no significant arrythmia or ST-T change during examination">no significant arrythmia or ST-T change during examination</option>
                            <option value="occasional VPCs and APCs noted during exercise">occasional VPCs and APCs noted during exercise</option>
                            <option value="OTHER">其他 (自由填寫)</option>
                        </select>
                        <input id="ekgOtherText" type="text" placeholder="請手寫 EKG 描述..." class="hidden w-full p-2 border-2 border-orange-300 rounded text-xs bg-orange-50 animate-pulse">
                    </div>

                    <div class="bg-white p-3 rounded-lg border border-indigo-200">
                        <label class="text-xs font-bold text-indigo-800 block mb-2 uppercase">6. HR Response / CI</label>
                        <select id="hrResponseSelect" class="w-full p-2 border rounded text-xs bg-slate-50 outline-indigo-500">
                            <option value="chronotropic incompetence was noted">chronotropic incompetence was noted</option>
                            <option value="Steep HR vs VO2 response was noted">Steep HR vs VO2 response was noted</option>
                            <option value="">(None / Empty)</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <div class="p-3 bg-white rounded border border-slate-200">
                            <p class="text-[10px] font-bold text-slate-500 mb-2 uppercase">10. 終止原因</p>
                            <div class="grid grid-cols-2 gap-2 text-[10px] mb-3">
                                <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="termReason" value="dyspnea"> dyspnea</label>
                                <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="termReason" value="leg fatigue"> leg fatigue</label>
                                <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="termReason" value="R reached"> R reached</label>
                                <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="termReason" value="BP drop"> BP drop</label>
                            </div>
                            <select id="termResult" class="w-full p-1.5 border rounded text-[11px] bg-slate-50">
                                <option value="maximal">maximal result</option>
                                <option value="submaximal">submaximal result</option>
                            </select>
                        </div>

                        <div class="p-3 bg-white rounded border border-indigo-200 shadow-sm">
                            <p class="text-[10px] font-bold text-indigo-700 mb-2 uppercase">11. AT/RCP 判定</p>
                            <div class="flex gap-4 text-[11px] mb-2 font-semibold">
                                <label class="flex items-center gap-1 cursor-pointer text-blue-600"><input type="radio" name="atObserved" value="yes" checked onchange="handleATToggle()"> 觀察到</label>
                                <label class="flex items-center gap-1 cursor-pointer text-rose-600"><input type="radio" name="atObserved" value="no" onchange="handleATToggle()"> 未觀察到</label>
                            </div>
                            <div id="atInputs" class="grid grid-cols-2 gap-2">
                                <input id="at_ml" type="number" step="0.1" placeholder="AT ml/kg" class="p-2 border rounded text-xs bg-slate-50">
                                <input id="rcp_ml" type="number" step="0.1" placeholder="RCP ml/kg" class="p-2 border rounded text-xs bg-slate-50">
                            </div>
                            <div id="atNoObservedArea" class="hidden space-y-2">
                                <select id="atNoReason" class="w-full p-2 border border-rose-200 rounded text-xs bg-rose-50 text-rose-700" onchange="toggleATNoOther()">
                                    <option value="AT/RCP not reached">AT/RCP not reached</option>
                                    <option value="AT/RCP undeterminated due to uneven breathing">AT/RCP undeterminated due to uneven breathing</option>
                                    <option value="OTHER">其他 (自由填寫)</option>
                                </select>
                                <input id="atNoOtherText" type="text" placeholder="輸入未觀察到之原因..." class="hidden w-full p-2 border-2 border-orange-300 rounded text-xs bg-orange-50 animate-pulse">
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 text-xs font-bold text-slate-600">
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="check12"> 12. Delayed HR recovery</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="check13"> 13. Inadequate BP response</label>
                    </div>
                </section>

                <section class="p-4 bg-emerald-50 rounded-xl border border-emerald-200 space-y-4">
                    <h2 class="text-sm font-bold text-emerald-800 border-b border-emerald-200 pb-1 text-center uppercase tracking-widest">C: Conclusion & Suggestion</h2>
                    
                    <div class="bg-white p-3 rounded-lg border border-emerald-100 shadow-sm">
                        <p class="text-xs font-bold text-emerald-700 mb-2 uppercase border-b pb-1">Conclusion (Select One)</p>
                        <div class="space-y-2 text-xs">
                            <label class="flex items-start gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded">
                                <input type="radio" name="conclMain" value="abnormal" checked class="mt-0.5 text-emerald-600 focus:ring-emerald-500">
                                <span class="text-slate-700">Abnormal (Auto FAI Severity)</span>
                            </label>
                            <label class="flex items-start gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded">
                                <input type="radio" name="conclMain" value="normal" class="mt-0.5 text-emerald-600 focus:ring-emerald-500">
                                <span class="text-slate-700">Essentially normal</span>
                            </label>
                            <label class="flex items-start gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded">
                                <input type="radio" name="conclMain" value="inconclusive" class="mt-0.5 text-emerald-600 focus:ring-emerald-500">
                                <span class="text-slate-700">Inconclusive</span>
                            </label>
                        </div>

                        <div class="mt-3 pt-2 border-t border-slate-100">
                            <label class="flex items-center gap-2 cursor-pointer mb-2">
                                <input type="checkbox" id="conclCompareCheck" onchange="document.getElementById('compareOptions').classList.toggle('hidden')">
                                <span class="text-xs font-bold text-slate-500">Comparison (Not 1st time)</span>
                            </label>
                            <div id="compareOptions" class="hidden grid grid-cols-2 gap-2">
                                <select id="compareStatus" class="p-1 border rounded text-[11px] bg-slate-50">
                                    <option value="Improved">Improved</option>
                                    <option value="Stationary">Stationary</option>
                                    <option value="Deteriorated">Deteriorated</option>
                                </select>
                                <input type="date" id="compareDate" class="p-1 border rounded text-[11px] bg-slate-50">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-3 rounded-lg border border-emerald-100 shadow-sm">
                        <p class="text-xs font-bold text-emerald-700 mb-2 uppercase border-b pb-1">Suggestion</p>
                        
                        <div class="mb-3">
                            <label class="flex items-center gap-2 cursor-pointer mb-1">
                                <input type="checkbox" id="sugg1Check" onchange="document.getElementById('sugg1Options').classList.toggle('hidden')">
                                <span class="text-xs font-bold text-slate-700">1. Continue Phase II CPT</span>
                            </label>
                            <div id="sugg1Options" class="hidden pl-5 grid grid-cols-2 gap-y-1 gap-x-1 mt-1">
                                <label class="flex items-center gap-1 cursor-pointer p-1 bg-slate-50 rounded border border-slate-100">
                                    <input type="checkbox" name="cptType" value="RPE guided intensity" class="rounded text-emerald-600">
                                    <span class="text-[10px]">RPE guided intensity</span>
                                </label>
                                <label class="flex items-center gap-1 cursor-pointer p-1 bg-slate-50 rounded border border-slate-100">
                                    <input type="checkbox" name="cptType" value="breathing retraining" class="rounded text-emerald-600">
                                    <span class="text-[10px]">Breathing retraining</span>
                                </label>
                                <label class="flex items-center gap-1 cursor-pointer p-1 bg-slate-50 rounded border border-slate-100">
                                    <input type="checkbox" name="cptType" value="resistance training" class="rounded text-emerald-600">
                                    <span class="text-[10px]">Resistance training</span>
                                </label>
                                <label class="flex items-center gap-1 cursor-pointer p-1 bg-slate-50 rounded border border-slate-100">
                                    <input type="checkbox" name="cptType" value="endurance training" class="rounded text-emerald-600">
                                    <span class="text-[10px]">Endurance training</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="flex items-start gap-2 cursor-pointer">
                                <input type="checkbox" id="sugg2Check">
                                <div class="flex flex-col">
                                    <span class="text-xs text-slate-700 font-bold">2. Drug modification</span>
                                    <span class="text-[10px] font-normal text-slate-400 leading-tight bg-slate-50 p-1 rounded mt-1 border border-slate-100">
                                        (Hints: VE/CO2 slope<34 不像是 heart failure, 但是血壓被抑制 (inadequate BP response) 或心跳被抑制 (chronotropic incompetence))
                                    </span>
                                </div>
                            </label>
                        </div>
                    </div>
                </section>

                <button onclick="generateReport()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-xl hover:bg-black transition-all uppercase tracking-[0.2em] active:scale-95 sticky bottom-0 z-10">
                    Generate Integrated Report
                </button>
                <div class="h-4"></div>
            </div>

            <div class="lg:col-span-7">
                <div class="sticky top-6">
                    <div class="flex justify-between items-center mb-2 px-2">
                        <h2 class="font-bold text-slate-500 text-xs tracking-[0.3em] uppercase">CLINICAL FINAL REPORT</h2>
                        <button onclick="copyToClipboard()" class="bg-indigo-600 text-white px-10 py-2 rounded-full text-xs font-bold hover:bg-indigo-700 shadow-lg transition-transform hover:scale-105 active:scale-95">COPY REPORT</button>
                    </div>
                    <textarea id="reportText" class="w-full h-[880px] p-8 text-[13.5px] font-mono border-2 border-slate-300 rounded-3xl bg-white leading-relaxed shadow-inner outline-none focus:border-indigo-400" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 輔助函式區域 ---
        function handleATToggle() {
            const isObserved = document.querySelector('input[name="atObserved"]:checked').value === 'yes';
            document.getElementById('atInputs').style.display = isObserved ? 'grid' : 'none';
            document.getElementById('atNoObservedArea').style.display = isObserved ? 'none' : 'block';
            toggleATNoOther();
        }

        function toggleATNoOther() {
            const status = document.getElementById('atNoReason').value;
            const otherInput = document.getElementById('atNoOtherText');
            otherInput.classList.toggle('hidden', status !== 'OTHER');
        }

        function toggleEKGOther() {
            const status = document.getElementById('ekgStatus').value;
            const otherInput = document.getElementById('ekgOtherText');
            otherInput.classList.toggle('hidden', status !== 'OTHER');
        }

        function getFAISeverity(faiValue) {
            // FAI severity: 0-28% no significant, 28-40% mild , 40-54% moderate , 54-68% marked, >68% extremely
            if (faiValue < 28) return "no significant";
            if (faiValue < 40) return "mild";
            if (faiValue < 54) return "moderate";
            if (faiValue < 68) return "marked";
            return "extremely";
        }

        // --- 主生成函式 ---
        function generateReport() {
            // 1. 取得基礎數值
            const pftStatus = document.getElementById('pftStatus').value;
            const fevfvc = document.getElementById('fevfvc').value || "__";
            const fvc_pred = document.getElementById('fvc_pred').value || "__";
            const age = parseFloat(document.getElementById('age').value);
            const restHR = parseFloat(document.getElementById('restHR').value) || 0;
            const peakHR = parseFloat(document.getElementById('peakHR').value) || 0;
            const peakVO2_ml = parseFloat(document.getElementById('peakVO2_ml').value) || 0;
            const peakVO2_L = parseFloat(document.getElementById('peakVO2_L').value) || 0;
            const predVO2_L = parseFloat(document.getElementById('predVO2_L').value) || 1; 
            const veMax = parseFloat(document.getElementById('veMax').value) || 0;
            const fev1 = parseFloat(document.getElementById('fev1').value) || 1;
            const oues = document.getElementById('oues').value || "__";
            const vevco2 = document.getElementById('vevco2').value || "__";
            const o2p = document.getElementById('o2p').value || "__";
            const predO2p = parseFloat(document.getElementById('predO2p').value) || 1;

            // 2. 數值計算
            let ciDisplay = "____";
            if(age && restHR && peakHR) {
                const ciValue = (peakHR - restHR) / ((220 - age) - restHR);
                ciDisplay = ciValue.toFixed(2);
            }
            const pPeakHR = age ? (peakHR * 100 / (220 - age)).toFixed(1) : "____";
            const peakMETs = peakVO2_ml ? (peakVO2_ml / 3.5).toFixed(1) : "____";
            const pPeakVO2 = (peakVO2_L * 100 / predVO2_L).toFixed(1);
            
            // FAI 計算
            const faiVal = (100 - (peakVO2_L / predVO2_L * 100)); // 這是 % FAI
            const faiDisplay = faiVal.toFixed(1);
            const faiSeverity = getFAISeverity(faiVal);

            const di = (veMax / (40 * fev1)).toFixed(2);
            const br = (1 - di).toFixed(2);
            const pO2p = o2p !== "__" ? (parseFloat(o2p) * 100 / predO2p).toFixed(1) : "____";

            // 3. 文字邏輯處理 (EKG, AT, etc.)
            const ekgSel = document.getElementById('ekgStatus').value;
            const ekgFinal = ekgSel === 'OTHER' ? document.getElementById('ekgOtherText').value : ekgSel;

            const reasons = Array.from(document.querySelectorAll('input[name="termReason"]:checked')).map(el => el.value);
            const termReasonText = reasons.length > 0 ? reasons.join(", ") : "____";

            // Point 6 Logic (Updated V12)
            const hrResponseSel = document.getElementById('hrResponseSelect').value;
            let line6 = "";
            if (hrResponseSel !== "") {
                // 如果有選項目，則顯示項目名稱加上 CI 數值
                line6 = `- ${hrResponseSel}; CI=${ciDisplay} (nl<0.8, if on BB<0.6)\n`;
            }

            // AT Logic
            const isAtObserved = document.querySelector('input[name="atObserved"]:checked').value === 'yes';
            let atLine = "";
            if (isAtObserved) {
                const atV = parseFloat(document.getElementById('at_ml').value) || 0;
                const rcpV = parseFloat(document.getElementById('rcp_ml').value) || 0;
                const atPct = peakVO2_ml > 0 ? (atV * 100 / peakVO2_ml).toFixed(1) : "0.0";
                const rcpPct = peakVO2_ml > 0 ? (rcpV * 100 / peakVO2_ml).toFixed(1) : "0.0";
                atLine = `- AT was about ${atV} ml/kg/min (${atPct}% of peak VO2); RCP was about ${rcpV} ml/kg/min (${rcpPct}% of peak VO2)`;
            } else {
                const atNoSel = document.getElementById('atNoReason').value;
                const atNoFinal = atNoSel === 'OTHER' ? document.getElementById('atNoOtherText').value : atNoSel;
                atLine = `- ${atNoFinal || "____"}`;
            }

            const line12 = document.getElementById('check12').checked ? `- Delayed heart rate recovery was observed\n` : "";
            const line13 = document.getElementById('check13').checked ? `- Inadequate BP response was noted\n` : "";

            // 4. Conclusion 區塊生成
            let conclusionText = "";
            const conclType = document.querySelector('input[name="conclMain"]:checked').value;
            
            if (conclType === 'abnormal') {
                conclusionText += `- Abnormal exercise testing with ${faiSeverity} FAI; the cause was due to decreased cardiac and pulmonary capacity;`;
            } else if (conclType === 'normal') {
                conclusionText += `- Essentially normal exercise testing`;
            } else {
                conclusionText += `- Inconclusive exercise testing`;
            }

            if (document.getElementById('conclCompareCheck').checked) {
                const status = document.getElementById('compareStatus').value;
                const date = document.getElementById('compareDate').value.replace(/-/g, '/'); // 格式化日期 YYYY/MM/DD
                conclusionText += `\n- ${status} compared to previous exam on ${date || "YYYY/MM/DD"}`;
            }

            // 5. Suggestion 區塊生成
            let suggestionLines = [];
            
            // Suggestion 1
            if (document.getElementById('sugg1Check').checked) {
                const cptTypes = Array.from(document.querySelectorAll('input[name="cptType"]:checked')).map(el => el.value);
                const cptString = cptTypes.length > 0 ? cptTypes.join(", ") : "____";
                suggestionLines.push(`- continue phase II CPT with {${cptString}}`);
            }

            // Suggestion 2 (Clean text only)
            if (document.getElementById('sugg2Check').checked) {
                suggestionLines.push(`- Drug modification`);
            }
            
            const suggestionText = suggestionLines.length > 0 ? `\n\nSuggestion:\n${suggestionLines.join('\n')}` : "";

            // 6. 最終報告組合 (全部改為 - 開頭，無數字)
            const report = 
`A: pulmonary function test: ${pftStatus}
- FEV1/FVC=${fevfvc}%
- FVC:${fvc_pred}% predicted value

B: CPTX result
- max HR:${peakHR};% predicted peak HR=${pPeakHR}%
- peak VO2:${peakVO2_ml}ml/kg/min; peak MET:${peakMETs}METs;% predicted peak VO2:${pPeakVO2}%
- % FAI=${faiDisplay}%
- Dyspnea index=${di};Breathing reserve=${br}
- EKG: ${ekgFinal || "____"}
${line6}- OUES: ${oues} ml/min
- VE/VCO2 slope: ${vevco2}
- O2 pulse: ${o2p} ; ${pO2p}% of predicted
- Exercise was terminated due to ${termReasonText}, ${document.getElementById('termResult').value}
${atLine}
${line12}${line13}- normal SpO2 response during exam

Conclusion:
${conclusionText}${suggestionText}`;

            document.getElementById('reportText').value = report;
        }

        function copyToClipboard() {
            const copyText = document.getElementById("reportText");
            if (!copyText.value) return;
            copyText.select();
            document.execCommand("copy");
            alert("完整報告內容已複製！");
        }
    </script>
</body>
</html>
